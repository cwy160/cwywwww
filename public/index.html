<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>外送平台</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 1rem; background: #fff; }
    h1 { text-align: center; }
    .menu { display: flex; flex-direction: column; gap: 1rem; max-width: 600px; margin: auto; }
    .section { border: 1px solid #ccc; border-radius: 8px; padding: 1rem; background: #f9f9f9; }
    .section.locked { opacity: 0.5; pointer-events: none; }
    .details { margin-top: 0.5rem; }
    button { margin: 0.25rem; padding: 0.5rem 1rem; font-size: 1rem; }
    #map, #final, #thanks { display: none; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; }
    .grid { display: grid; grid-template-columns: repeat(4, 50px); gap: 10px; margin-top: 1rem; }
    .grid div { width: 50px; height: 50px; border: 2px solid black; display: flex; align-items: center; justify-content: center; }
    .grid .active { background: red; color: white; font-weight: bold; }
    #arrow { width: 40px; height: 40px; background: red; clip-path: polygon(50% 0%, 100% 100%, 50% 75%, 0% 100%); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; }
  </style>
</head>
<body>
<h1>外送平台</h1>
<div id="menu" class="menu"></div>
<div id="map"><p>外送員正在前往您的位置...</p><div id="arrow"></div></div>
<div id="final">
  <p>您的餐點已送達</p>
  <button onclick="confirmDelivery()">確認收餐</button>
</div>
<div id="thanks">
  <div class="grid" id="grid"></div>
  <p id="pickup-text"></p>
  <p>謝謝您的惠顧</p>
  <button onclick="goHome()">回首頁</button>
</div>
<script>
const menuData = {
  group1: [
    { label: 'A1', motor: 'motor1' },
    { label: 'A2', motor: 'motor2' },
    { label: 'A3', motor: 'motor3' },
    { label: 'A4', motor: 'motor4' }
  ],
  group2: [
    { label: 'B1', motor: 'motor5' },
    { label: 'B2', motor: 'motor6' },
    { label: 'B3', motor: 'motor7' },
    { label: 'B4', motor: 'motor8' }
  ],
  group3: [
    { label: 'C1', motor: 'motor9' },
    { label: 'C2', motor: 'motor10' },
    { label: 'C3', motor: 'motor11' },
    { label: 'C4', motor: 'motor12' }
  ],
  group4: [
    { label: 'D1', motor: 'motor13' },
    { label: 'D2', motor: 'motor14' },
    { label: 'D3', motor: 'motor15' },
    { label: 'D4', motor: 'motor16' }
  ]
};
const lockStatus = {};
let selectedMotor = '';
let deliveryInterval = null;
let deliveryProgress = 0;
const menu = document.getElementById('menu');
Object.entries(menuData).forEach(([group, items]) => {
  const section = document.createElement('div');
  section.className = 'section';
  const detailDiv = document.createElement('div');
  detailDiv.className = 'details';
  items.forEach(({ label, motor }) => {
    const btn = document.createElement('button');
    btn.innerText = label;
    btn.onclick = () => prepareDelivery(motor);
    btn.dataset.motor = motor;
    detailDiv.appendChild(btn);
  });
  section.appendChild(document.createElement('div')).innerText = group;
  section.appendChild(detailDiv);
  menu.appendChild(section);
});
function prepareDelivery(motorKey) {
  if (lockStatus[motorKey]) return;
  selectedMotor = motorKey;
  lockStatus[motorKey] = true;
  updateLockUI();
  setTimeout(() => {
    lockStatus[motorKey] = false;
    updateLockUI();
  }, 7000);
  document.getElementById('menu').style.display = 'none';
  document.getElementById('map').style.display = 'flex';
  document.getElementById('arrow').style.display = 'block';
  deliveryProgress = 0;
  updateMapPosition();
  deliveryInterval = setInterval(() => {
    deliveryProgress += 10;
    updateMapPosition();
    if (deliveryProgress >= 100) {
      clearInterval(deliveryInterval);
      document.getElementById('map').style.display = 'none';
      document.getElementById('arrow').style.display = 'none';
      document.getElementById('final').style.display = 'flex';
    }
  }, 1000);
}
function confirmDelivery() {
  fetch('https://vber-vhtk.onrender.com/send', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ data: selectedMotor })
  });
  document.getElementById('final').style.display = 'none';
  document.getElementById('thanks').style.display = 'block';
  drawGrid(selectedMotor);
}
function goHome() {
  document.getElementById('thanks').style.display = 'none';
  document.getElementById('menu').style.display = 'flex';
}
function updateLockUI() {
  document.querySelectorAll('button[data-motor]').forEach(btn => {
    const key = btn.dataset.motor;
    btn.disabled = !!lockStatus[key];
  });
}
function drawGrid(motorKey) {
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  const motorNum = parseInt(motorKey.replace('motor', ''));
  for (let i = 1; i <= 16; i++) {
    const cell = document.createElement('div');
    if (i === motorNum) cell.className = 'active';
    cell.innerText = `${Math.ceil(i / 4)}-${((i - 1) % 4) + 1}`;
    grid.appendChild(cell);
  }
  const text = document.getElementById('pickup-text');
  text.innerText = `請查收您的餐點，取餐位置為 ${Math.ceil(motorNum / 4)}-${((motorNum - 1) % 4) + 1}`;
}
// 📍 顯示方向箭頭功能
if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
  document.addEventListener('click', () => {
    DeviceOrientationEvent.requestPermission().then(state => {
      if (state === 'granted') {
        window.addEventListener('deviceorientation', handleOrientation);
      }
    });
  });
} else {
  window.addEventListener('deviceorientation', handleOrientation);
}
function handleOrientation(e) {
  const arrow = document.getElementById('arrow');
  if (arrow && typeof e.alpha === 'number') {
    arrow.style.transform = `translate(-50%, -50%) rotate(${e.alpha}deg)`;
  }
}
</script>
</body>
</html>
