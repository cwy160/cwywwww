<script>
  // å®šä½èˆ‡æ–¹å‘åµæ¸¬
  function startGeoTracking() {
    navigator.geolocation.watchPosition(pos => {
      const user = document.getElementById('user');
      const arrow = document.getElementById('arrow');
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      user.style.left = '150px';
      user.style.top = '150px';
      arrow.style.left = '155px';
      arrow.style.top = '140px';
    });

    if (window.DeviceOrientationEvent) {
      window.addEventListener('deviceorientation', e => {
        const angle = e.alpha;
        const arrow = document.getElementById('arrow');
        if (angle != null) {
          arrow.style.transform = `rotate(${angle}deg)`;
        }
      });
    }
  }

  const menuData = {
    ç«è±†è…: [
      { label: 'å°è¾£', motor: 'motor1' },
      { label: 'ä¸­è¾£', motor: 'motor2' },
      { label: 'å¤§è¾£', motor: 'motor3' }
    ],
    é’æ¸…æª¸èŒ¶: [
      { label: 'å¾®ç³–', motor: 'motor4' },
      { label: 'åŠç³–', motor: 'motor5' },
      { label: 'å…¨ç³–', motor: 'motor6' }
    ],
    ç²’å­è±†è…: [
      { label: 'é™„æ¹¯', motor: 'motor7' },
      { label: 'ä¸é™„æ¹¯', motor: 'motor8' },
    ],
    æˆ‘è±†è…: [
      { label: 'é™„æ¹¯', motor: 'motor9' },
      { label: 'ä¸é™„æ¹¯', motor: 'motor10' }
    ],
    è±†è…: [
      { label: 'å°è¾£', motor: 'motor11' },
      { label: 'ä¸­è¾£', motor: 'motor12' },
      { label: 'å¤§è¾£', motor: 'motor13' },
    ],
    é’èŒ¶: [
      { label: 'å°è¾£', motor: 'motor14' },
      { label: 'ä¸­è¾£', motor: 'motor15' },
      { label: 'å¤§è¾£', motor: 'motor16' },
    ],
    æˆ‘è…: [
      { label: 'é™„æ¹¯', motor: 'motor9' },
      { label: 'ä¸é™„æ¹¯', motor: 'motor10' }
    ],
    ç«è…: [
      { label: 'å°è¾£', motor: 'motor11' },
      { label: 'ä¸­è¾£', motor: 'motor12' },
      { label: 'å¤§è¾£', motor: 'motor13' },
    ],
    æª¸èŒ¶: [
      { label: 'å°è¾£', motor: 'motor14' },
      { label: 'ä¸­è¾£', motor: 'motor15' },
      { label: 'å¤§è¾£', motor: 'motor16' },
    ],
  };

  const lockStatus = {};
  const menuDiv = document.getElementById('menu');
  let selectedMotor = '';

  async function syncLockStatus() {
    try {
      const res = await fetch('https://cwywwww.onrender.com/status');
      const data = await res.json();
      Object.assign(lockStatus, data);
      updateLockUI();
    } catch (e) {
      console.error('åŒæ­¥ç‹€æ…‹å¤±æ•—', e);
    }
  }
  setInterval(syncLockStatus, 1000);

  Object.entries(menuData).forEach(([label, items]) => {
    const section = document.createElement('div');
    section.className = 'section';
    section.innerHTML = `<div class="label">${label}</div>
      <div class="details">
        <div class="item-buttons">
          ${items.map(i => `<button class="order-btn" data-motor="${i.motor}" onclick="prepareDelivery('${i.motor}')">${i.label}</button>`).join('')}
        </div>
        <div class="locked-message" style="display:none;">è©²é¸é …å·²å”®ç½„ï¼Œè«‹ç¨å¾Œè£œè²¨</div>
        <button class="back-button" onclick="goBack()">è¿”å›ä¸Šä¸€é </button>
      </div>`;
    section.addEventListener('click', () => {
      if (items.every(i => lockStatus[i.motor])) return;
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      section.classList.add('active');
    });
    menuDiv.appendChild(section);
  });

  async function prepareDelivery(motorKey) {
    await fetch('https://vber-vhtk.onrender.com/lock', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ motor: motorKey })
    });

    if (lockStatus[motorKey]) return;

    selectedMotor = motorKey;
    lockStatus[motorKey] = true;
    updateLockUI();
    goBack();

    // ğŸ”½ æ–°å¢ï¼šå°‡æ‰€æœ‰ç¶å®šåŒ motor çš„æŒ‰éˆ•æš«æ™‚ç¦ç”¨
    const allButtons = document.querySelectorAll(`button[data-motor="${motorKey}"]`);
    allButtons.forEach(btn => {
      btn.disabled = true;
      btn.style.opacity = '0.5';
      btn.style.cursor = 'not-allowed';
    });

    setTimeout(() => {
      lockStatus[motorKey] = false;
      updateLockUI();

      // ğŸ”½ æ–°å¢ï¼šæ¢å¾©æŒ‰éˆ•ç‹€æ…‹
      allButtons.forEach(btn => {
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
      });
    }, 7000);

    // åŸæµç¨‹ï¼šæ¨¡æ“¬åœ°åœ–èˆ‡é€é”
    document.getElementById('menu').style.display = 'none';
    document.getElementById('map').style.display = 'block';
    startGeoTracking();

    const courier = document.getElementById('courier');
    courier.style.left = '150px';
    courier.style.top = '150px';

    setTimeout(() => {
      document.getElementById('map').style.display = 'none';
      document.getElementById('delivered').style.display = 'block';
    }, 10000);
  }

  async function confirmDelivery() {
    document.getElementById('delivered').style.display = 'none';
    showGrid(selectedMotor);
  }

  function showGrid(motorKey) {
    const table = document.getElementById('gridTable');
    table.innerHTML = '';
    const pos = parseInt(motorKey.replace('motor', ''));
    const row = Math.floor((pos - 1) / 4) + 1;
    const col = ((pos - 1) % 4) + 1;
    for (let r = 1; r <= 4; r++) {
      const tr = document.createElement('tr');
      for (let c = 1; c <= 4; c++) {
        const td = document.createElement('td');
        if (r === row && c === col) td.className = 'highlight';
        td.textContent = `${r}-${c}`;
        tr.appendChild(td);
      }
      table.appendChild(tr);
    }
    document.getElementById('pickupText').textContent = `è«‹æŸ¥æ”¶æ‚¨çš„é¤é»ï¼Œå–é¤ä½ç½®ç‚ºï¼š${row}-${col}`;
    document.getElementById('grid').style.display = 'block';
    setTimeout(() => {
      document.getElementById('grid').style.display = 'none';
      document.getElementById('thanks').style.display = 'block';
    }, 7000);
  }

  function updateLockUI() {
    document.querySelectorAll('.section').forEach(section => {
      const buttons = section.querySelectorAll('.order-btn');
      const lockedMessage = section.querySelector('.locked-message');
      const backButton = section.querySelector('.back-button');

      let allLocked = true;
      buttons.forEach(btn => {
        const motorKey = btn.dataset.motor;
        if (lockStatus[motorKey]) {
          btn.style.display = 'none';
        } else {
          btn.style.display = 'inline-block';
          allLocked = false;
        }
      });

      if (allLocked) {
        section.classList.add('locked');
        if (lockedMessage) lockedMessage.style.display = 'block';
        if (backButton) backButton.style.display = 'inline-block';
      } else {
        section.classList.remove('locked');
        if (lockedMessage) lockedMessage.style.display = 'none';
        if (backButton) backButton.style.display = 'none';
      }
    });
  }

  function goBack() {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  }

  function goBackHome() {
    document.getElementById('thanks').style.display = 'none';
    document.getElementById('menu').style.display = 'block';
  }
</script>